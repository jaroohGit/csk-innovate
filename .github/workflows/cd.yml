name: CD Pipeline - Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # =====================================
  # Job 1: Prepare Release
  # =====================================
  prepare:
    name: ğŸ“‹ Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

  # =====================================
  # Job 2: Build Production
  # =====================================
  build-production:
    name: ğŸ—ï¸ Build for Production
    runs-on: ubuntu-latest
    needs: [prepare]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --production=false
        
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_VERSION: ${{ needs.prepare.outputs.version }}
          
      - name: ğŸ“¦ Package application
        run: |
          mkdir -p deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/
          cp package*.json deploy-package/
          cp next.config.mjs deploy-package/
          tar -czf csk-innovate-${{ needs.prepare.outputs.version }}.tar.gz deploy-package/
          
      - name: ğŸ“¤ Upload package
        uses: actions/upload-artifact@v3
        with:
          name: production-package
          path: csk-innovate-${{ needs.prepare.outputs.version }}.tar.gz
          retention-days: 30

  # =====================================
  # Job 3: Deploy to Vercel
  # =====================================
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [prepare, build-production]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      url: https://www.cskinnovate.com
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

  # =====================================
  # Job 4: Deploy to VPS (Alternative)
  # =====================================
  deploy-vps:
    name: ğŸ–¥ï¸ Deploy to VPS
    runs-on: ubuntu-latest
    needs: [prepare, build-production]
    if: github.event.inputs.environment == 'production' || github.ref == 'refs/heads/main'
    environment:
      name: vps-production
      url: https://www.cskinnovate.com
    
    steps:
      - name: ğŸ“¥ Download package
        uses: actions/download-artifact@v3
        with:
          name: production-package
          
      - name: ğŸ“¤ Deploy to VPS via SSH
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "csk-innovate-${{ needs.prepare.outputs.version }}.tar.gz"
          target: "/tmp/"
          
      - name: ğŸ”„ Execute deployment script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /tmp
            tar -xzf csk-innovate-${{ needs.prepare.outputs.version }}.tar.gz
            
            # Backup current deployment
            if [ -d /var/www/html ]; then
              sudo mkdir -p /home/backups
              sudo mv /var/www/html /home/backups/backup-$(date +%Y%m%d_%H%M%S)
            fi
            
            # Deploy new version
            sudo mkdir -p /var/www/html
            sudo mv deploy-package/* /var/www/html/
            
            # Install dependencies
            cd /var/www/html
            sudo npm ci --production
            
            # Set permissions
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
            
            # Restart application
            sudo pm2 delete csk-innovate || true
            sudo pm2 start npm --name "csk-innovate" -- start
            sudo pm2 save
            
            echo "âœ… Deployment completed successfully!"

  # =====================================
  # Job 5: Deploy API Backend
  # =====================================
  deploy-api:
    name: ğŸ”Œ Deploy API Backend
    runs-on: ubuntu-latest
    needs: [prepare]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¤ Deploy API to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "api/*"
          target: "/var/www/csk-api/"
          
      - name: ğŸ”„ Restart API service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd /var/www/csk-api/api
            npm ci --production
            pm2 delete csk-api || true
            pm2 start server.js --name "csk-api"
            pm2 save

  # =====================================
  # Job 6: Health Check
  # =====================================
  health-check:
    name: ğŸ¥ Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: always()
    
    steps:
      - name: ğŸ¥ Check website health
        run: |
          echo "Checking https://www.cskinnovate.com"
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.cskinnovate.com)
            if [ $STATUS -eq 200 ]; then
              echo "âœ… Website is healthy (HTTP $STATUS)"
              exit 0
            fi
            echo "â³ Attempt $i/5: HTTP $STATUS, waiting..."
            sleep 10
          done
          echo "âŒ Health check failed"
          exit 1
          
      - name: ğŸ“Š Check API health
        run: |
          echo "Checking API endpoint"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.cskinnovate.com/api/health || echo "000")
          if [ $STATUS -eq 200 ]; then
            echo "âœ… API is healthy"
          else
            echo "âš ï¸ API health check returned: $STATUS"
          fi
        continue-on-error: true

  # =====================================
  # Job 7: Notify
  # =====================================
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-vercel, health-check]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify on success
        if: needs.deploy-vercel.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ URL: https://www.cskinnovate.com"
          echo "ğŸ“¦ Version: ${{ needs.prepare.outputs.version }}"
          
      - name: ğŸ“¢ Notify on failure
        if: needs.deploy-vercel.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs for details"
